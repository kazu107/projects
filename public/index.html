<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <title>Online Judge by kazu107</title>
</head>
<body>
<header>
    <a href="/" class="header-left">
        <img src="pictures/kazu107.png" alt="サイトのアイコン" class="icon">
        <span class="site-name">Online Judge by kazu107</span>
    </a>
    <div id="auth-links">
        <!-- 認証リンクがここに挿入されます -->
    </div>
</header>
<main>
    <!-- 使い方 -->
    <div class="title-container">
        <h1 class="main-title">使い方</h1>
        <ul class="item-list">
            <li>アカウントを作成しなくてもサンプル問題が解けます。</li>
            <li>新規登録とログインをすることで自分の問題を作れます。（工事中）</li>
            <li>問題は、全体公開や任意のアカウント間での共有ができます。（工事中）</li>
            <li>自作の問題や既存の問題を使用して、独自のプログラミングコンテストを開催できます。（工事中）</li>
            <li>ダッシュボードで問題を管理してみましょう。（）</li>
        </ul>
    </div>
    <!-- 問題リンク -->
    <div class="title-container">
        <h1 class="main-title">サンプル問題</h1>
        <div class="box-container">
            <div class="row">
                <!-- 入力のやり方 -->
                <div class="box">
                    <h2 class="box-title title-1">入力のやり方</h2>
                    <ul class="box-list">
                        <li><a href="/problem/input_p1.html" target="_blank"><i class="fas fa-file-alt"></i>0-1:文字列</a></li>
                        <li><a href="/problem/input_p2.html" target="_blank"><i class="fas fa-file-alt"></i>0-2:整数</a></li>
                        <li><a href="/problem/input_p3.html" target="_blank"><i class="fas fa-file-alt"></i>0-3:小数</a></li>
                        <li><a href="/problem/input_p4.html" target="_blank"><i class="fas fa-file-alt"></i>0-4:2つの文字列</a></li>
                        <li><a href="/problem/input_p5.html" target="_blank"><i class="fas fa-file-alt"></i>0-5:2つの整数</a></li>
                        <li><a href="/problem/input_p6.html" target="_blank"><i class="fas fa-file-alt"></i>0-6:複数の文字列</a></li>
                        <li><a href="/problem/input_p7.html" target="_blank"><i class="fas fa-file-alt"></i>0-7:複数の整数</a></li>
                        <li><a href="/problem/input_p8.html" target="_blank"><i class="fas fa-file-alt"></i>0-8:複数行</a></li>
                        <li><a href="/problem/input_p9.html" target="_blank"><i class="fas fa-file-alt"></i>0-9:複数行複数列</a></li>
                    </ul>
                </div>
                <!-- １章 -->
                <div class="box">
                    <h2 class="box-title title-2">１章</h2>
                    <ul class="box-list">
                        <li><a href="/problem/p1-1.html" target="_blank"><i class="fas fa-file-alt"></i>1-1:テストの点</a></li>
                        <li><a href="/problem/p1-2.html" target="_blank"><i class="fas fa-file-alt"></i>1-2:すごろく</a></li>
                        <li><a href="/problem/p1-3.html" target="_blank"><i class="fas fa-file-alt"></i>1-3:身長</a></li>
                        <li><a href="/problem/p1-4.html" target="_blank"><i class="fas fa-file-alt"></i>1-4:会合</a></li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <!-- ２章 -->
                <div class="box">
                    <h2 class="box-title title-3">２章</h2>
                    <ul class="box-list">
                        <li><a href="/problem/p2-1.html" target="_blank"><i class="fas fa-file-alt"></i>2-1:ゲーム木改題</a></li>
                        <li><a href="/problem/p2-2.html" target="_blank"><i class="fas fa-file-alt"></i>2-1:巡回セールスマン改題</a></li>
                    </ul>
                </div>
                <!-- ３章 -->
                <div class="box">
                    <h2 class="box-title title-4">３章</h2>
                    <ul class="box-list">
                        <li><a href="/problem/input_p1.html" target="_blank"><i class="fas fa-file-alt"></i>0-1:文字列</a></li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="box">
                    <!-- ４章 -->
                    <h2 class="box-title title-5">４章</h2>
                    <ul class="box-list">
                        <li><a href="#" target="_blank"><i class="fas fa-file-alt"></i> リンク13</a></li>
                        <li><a href="#" target="_blank"><i class="fas fa-file-alt"></i> リンク14</a></li>
                        <li><a href="#" target="_blank"><i class="fas fa-file-alt"></i> リンク15</a></li>
                    </ul>
                </div>
                <div class="box">
                    <!-- ５章 -->
                    <h2 class="box-title title-6">章</h2>
                    <ul class="box-list">
                        <li><a href="/problem/ptest.html" target="_blank"><i class="fas fa-file-alt"></i>config</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="title-container">
        <div class="search-container">
            <h2 class="search-title">全ユーザーの解答</h2>
            <input id="searchUser" type="text" class="search-box" placeholder="ユーザーを検索">
            <select id="stat" class="search-select">
                <option value="all">All</option>
                <option value="ac">AC</option>
                <option value="wa">WA</option>
            </select>
            <select id="amount" class="search-select">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="30">30</option>
            </select>
            <button id="search" class="search-button">検索</button>
        </div>
        <div class="table-container">
            <table id="result" class="user-table">
                <thead>
                <tr>
                    <th>提出日時</th>
                    <th>ユーザー名</th>
                    <th>問題</th>
                    <th>結果</th>
                    <th>実行時間</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <!-- データがここに入る -->

                </tbody>
            </table>
        </div>
    </div>
</main>
<script src="/socket.io/socket.io.js"></script>
<script>
    // テーブルの表示・非表示を切り替える
    document.addEventListener('DOMContentLoaded', function() {
        function bindToggleButtons() {
            document.querySelectorAll('.toggle-btn').forEach(function(btn, index) {
                btn.addEventListener('click', function() {
                    const codeRow = btn.closest('tr').nextElementSibling;
                    if (codeRow.style.display === 'table-row') {
                        codeRow.style.display = 'none';
                    } else {
                        codeRow.style.display = 'table-row';
                        const editor = ace.edit('editor' + (index + 1));
                        editor.setTheme('ace/theme/monokai');
                        editor.session.setMode('ace/mode/python');
                        editor.setReadOnly(true);
                    }
                });
            });
            document.querySelectorAll('.code-row').forEach(function(row) {
                row.style.display = 'none';
            });
        }

        const socket = io();
        // 検索ボタンがクリックされたときの処理
        function performSearch() {
            const searchUser = document.getElementById('searchUser').value;
            const stat = document.getElementById('stat').value;
            const amount = document.getElementById('amount').value;
            console.log("send with " + searchUser + " " + stat + " " + amount);
            socket.emit('search', searchUser, stat, amount);
        }

        document.getElementById('search').addEventListener('click', performSearch);
        // 検索結果を受信したときの処理
        socket.on('searchResult', function(data) {
            console.log("---receive data---\n" + data);
            const tableBody = document.querySelector('#result tbody');
            // テーブルの中身を空にする
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            for (let i = 0; i < data.length; i++) {
                // テーブルにデータを追加する
                const newRow1 = document.createElement('tr');
                newRow1.innerHTML = `
                        <td>${data[i].solved_date}</td>
                        <td>${data[i].users}</td>
                        <td>${data[i].probs}</td>
                        <td>${data[i].is_correct}</td>
                        <td>${data[i].execute_time}ms</td>
                        <td><button class="toggle-btn">^</button></td>
                    `;
                // class="code-row"でソースコードを追加
                const newRow2 = document.createElement('tr');
                newRow2.className = 'code-row';
                newRow2.innerHTML = `
                        <td colspan="6">
                            <div id="editor${i + 1}" class="editor">${data[i].source_code}</div>
                        </td>
                    `;
                tableBody.appendChild(newRow1);
                tableBody.appendChild(newRow2);
            }
            // 新しいデータに対してクリックイベントをバインドする
            bindToggleButtons();
        });
        // ページが読み込まれた際にデフォルトの値で検索を実行
        performSearch();
    });


    async function fetchWithAuth(url, options = {}) {
        let token = localStorage.getItem('token');
        options.headers = options.headers || {};
        options.headers['Authorization'] = 'Bearer ' + token;
        let response = await fetch(url, options);
        if (!token) {
            return response;
        }


        if (response.status === 401) {  // トークンの期限切れ
            const refreshToken = localStorage.getItem('refreshToken');
            if (!refreshToken) {
                window.location.href = '/login.html';
                return;
            }

            const refreshResponse = await fetch('/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refreshToken })
            });

            if (refreshResponse.ok) {
                const refreshResult = await refreshResponse.json();
                localStorage.setItem('token', refreshResult.accessToken);
                localStorage.setItem('refreshToken', refreshResult.refreshToken);

                options.headers['Authorization'] = 'Bearer ' + refreshResult.accessToken;
                response = await fetch(url, options);
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('refreshToken');
                window.location.href = '/login.html';
                return;
            }
        }

        return response;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const authLinks = document.getElementById('auth-links');
        const response = await fetchWithAuth('/profile');

        if (response.ok) {
            const user = await response.json();
            authLinks.innerHTML = `
                <a href="/dashboard.html" class="auth-link"><i class="fas fa-user"></i> ${user.username}</a>
                <a href="#" id="logout" class="auth-link"><i class="fas fa-sign-out-alt"></i> ログアウト</a>
            `;
            document.getElementById('logout').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('refreshToken');
                location.reload();
            });
        } else {
            authLinks.innerHTML = `
                <a href="/register.html" class="auth-link"><i class="fas fa-user-plus"></i> Register</a>
                <a href="/login.html" class="auth-link"><i class="fas fa-sign-in-alt"></i> Login</a>
            `;
        }
    });
</script>
</body>
</html>